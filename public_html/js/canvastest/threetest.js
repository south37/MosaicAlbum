// Generated by CoffeeScript 1.6.3
$(function() {
  return window.addEventListener("DOMContentLoaded", function() {
    var mosaicImagePath, selectedImagePath;
    $('#showMosaic').tooltip({
      placement: 'top',
      title: 'くりっくしてね',
      triger: 'hover'
    });
    $('#modal1 .modal-header').empty().append("members:xx,oo").append('<button id="closeModal" class="btn">x</button>');
    $('#modal1 .modal-body').empty();
    $('#modal1 .modal-footer').empty().append('右クリックで保存できます ').append('<button id="fb_share" class="btni btn-primary">facebookでshare</button>');
    mosaicImagePath = "";
    selectedImagePath = "";
    $('#showMosaic').click(function() {
      $('#modal1 .modal-body').empty().append("<img src=" + mosaicImagePath + " alt='modaicImg'></img>");
      $('#modal1').modal('toggle');
      return console.log(mosaicImagePath);
    });
    $('#showSelect').click(function() {
      $('#modal1 .modal-body').empty().append("<img src=" + selectedImagePath + " alt='selectedImg'></img>");
      $('#modal1').modal('toggle');
      return console.log(selectedImagePath);
    });
    $('#closeModal').click(function() {
      return $('#modal1').modal('toggle');
    });
    $('#fb_share').click(function() {
      return alert("shareしたよ");
    });
    return $.getJSON("/common/mosaic_viewer/ajax_list", function(data) {
      var anim, aspect, camera, cameraPosition, cnt, directioalLight, farClip, fbIconGeometry, fbIconMaterials, fov, height, isTweenInitiaized, key, lookTarget, mosaicPieceGeometry, mosaicPieceMaterials, moveTime, nearClip, offsetTime, offsetTimeMax, piece, piecedata, position, projector, renderer, scene, sizeX, sizeY, target, tmpTex, trackball, tweenList, twn, userNum, userPosList, userPosMax, userPosMin, val, width, _i, _len, _ref, _ref1, _ref2;
      console.log(data);
      mosaicImagePath = data.mosaicInfo.mosaicPath;
      width = window.innerWidth;
      height = window.innerHeight - 100;
      width = $('#container').innerWidth();
      renderer = new THREE.WebGLRenderer();
      renderer.setSize(width, height);
      $('#forCanvas').append(renderer.domElement);
      renderer.setClearColor(0x000000, 1);
      scene = new THREE.Scene();
      fov = 80;
      aspect = width / height;
      nearClip = 1;
      farClip = 10000;
      camera = new THREE.PerspectiveCamera(fov, aspect, nearClip, farClip);
      lookTarget = new THREE.Vector3(0, 0, 0);
      cameraPosition = new THREE.Vector3(0, 0, 1000);
      camera.position.copy(cameraPosition);
      scene.add(camera);
      camera.lookAt(lookTarget);
      trackball = new THREE.TrackballControls(camera, renderer.domElement);
      directioalLight = new THREE.DirectionalLight(0xffffff, 3);
      directioalLight.position.z = 300;
      scene.add(directioalLight);
      fbIconMaterials = {};
      _ref = data.userInfo;
      for (key in _ref) {
        val = _ref[key];
        tmpTex = new THREE.ImageUtils.loadTexture(val);
        fbIconMaterials[key] = new THREE.MeshBasicMaterial({
          map: tmpTex,
          side: THREE.DoubleSide
        });
      }
      mosaicPieceMaterials = {};
      _ref1 = data.mosaicPieceMap;
      for (key in _ref1) {
        val = _ref1[key];
        tmpTex = new THREE.ImageUtils.loadTexture('/' + val);
        mosaicPieceMaterials[key] = new THREE.MeshBasicMaterial({
          map: tmpTex,
          side: THREE.DoubleSide
        });
      }
      sizeX = 100;
      sizeY = 100;
      fbIconGeometry = new THREE.PlaneGeometry(sizeX, sizeY, 1, 1);
      userPosList = {};
      sizeX = 10;
      sizeY = 10;
      mosaicPieceGeometry = new THREE.PlaneGeometry(sizeX, sizeY, 1, 1);
      tweenList = [];
      userNum = data.mosaicInfo.userNum;
      userPosMin = new THREE.Vector3(-500, -300, 100);
      userPosMax = new THREE.Vector3(500, -300, 100);
      cnt = 0;
      for (key in fbIconMaterials) {
        val = fbIconMaterials[key];
        piece = new THREE.Mesh(fbIconGeometry, val);
        position = new THREE.Vector3().copy(userPosMin).lerp(userPosMax, cnt / (userNum - 1));
        piece.position.copy(position);
        scene.add(piece);
        userPosList[key] = position;
        cnt += 1;
      }
      console.log(userPosList);
      cnt = 0;
      offsetTimeMax = 3000;
      _ref2 = data.mosaicPieces;
      for (_i = 0, _len = _ref2.length; _i < _len; _i++) {
        piecedata = _ref2[_i];
        piece = new THREE.Mesh(mosaicPieceGeometry, mosaicPieceMaterials[piecedata.image_id]);
        piece.position.copy(userPosList[piecedata.user_id]);
        piece.fb_image_id = piecedata.fb_image_id;
        scene.add(piece);
        target = new THREE.Vector3(piecedata.x * sizeX - 500, 500 - piecedata.y * sizeY, 0);
        moveTime = 300;
        offsetTime = 100 + 10 * Math.floor(Math.random() * offsetTimeMax);
        twn = new TWEEN.Tween(piece.position).to(target, moveTime).delay(offsetTime);
        tweenList.push(twn);
        cnt += 1;
      }
      projector = new THREE.Projector();
      $(renderer.domElement).bind('mousedown', function(e) {
        var mouseX2D, mouseX3D, mouseY2D, mouseY3D, obj, path, ray, tmp_id, vec;
        console.log("rendererclicked");
        mouseX2D = e.clientX - e.target.offsetLeft;
        mouseY2D = e.clientY - e.target.offsetTop;
        mouseX3D = (mouseX2D / e.target.width) * 2 - 1;
        mouseY3D = (mouseY2D / e.target.height) * -2 + 1;
        console.log("click:", mouseX3D, ":", mouseY3D);
        vec = new THREE.Vector3(mouseX3D, mouseY3D, -1);
        projector.unprojectVector(vec, camera);
        ray = new THREE.Raycaster(camera.position, vec.sub(camera.position).normalize());
        obj = ray.intersectObjects(scene.children, true);
        if (obj.length > 0) {
          tmp_id = obj[0].object.fb_image_id;
          path = '/common/mosaic_viewer/ajax_fb_image/' + tmp_id;
          return $.getJSON(path, function(data) {
            console.log(data);
            return selectedImagePath = data.fb_image_path;
          });
        } else {
          return console.log("no clicked object");
        }
      });
      isTweenInitiaized = false;
      $('canvas').mouseup(function() {
        var _j, _len1;
        if (!isTweenInitiaized) {
          for (_j = 0, _len1 = tweenList.length; _j < _len1; _j++) {
            twn = tweenList[_j];
            twn.start();
          }
          return isTweenInitiaized = true;
        }
      });
      $(window).bind('resize', function() {
        console.log("window resize");
        width = $('#container').innerWidth();
        height = window.innerHeight - 100;
        renderer.setSize(width, height);
        camera.aspect = width / height;
        return camera.updateProjectionMatrix();
      });
      anim = function() {
        requestAnimationFrame(anim);
        trackball.update();
        TWEEN.update();
        return renderer.render(scene, camera);
      };
      renderer.render(scene, camera);
      return anim();
    });
  });
});
